{% extends "core/base.html" %}

{% block title %}Home - Licentia{% endblock %}
{% block page_title %}Visão geral{% endblock %}

{% block content %}
<div class="card mb-3">
    <div class="card-body">
        <form method="get" class="row g-2">
            <div class="col-md-4">
                <label class="form-label">Projeto</label>
                <select name="projeto" class="form-select">
                    <option value="">Todos</option>
                    {% for p in projetos %}
                        <option 
                            value="{{ p.id }}" 
                            {% if request.GET.projeto == p.id|stringformat:"s" %}selected{% endif %}
                            >
                                {{ p.nome }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Componente</label>
                <select name="componente" class="form-select">
                    <option value="">Todos</option>
                    {% for c in componentes %}
                        <option 
                            value="{{ c.id }}" 
                            {% if request.GET.componente == c.id|stringformat:"s" %}selected{% endif %}
                            >
                                {{ c.nome }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Volume</label>
                <input type="number" name="volume" value="{{ request.GET.volume }}" class="form-control">
            </div>
            <div class="col-md-3 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary flex-fill">
                    <i class="fa-solid fa-filter me-2"></i>Filtrar
                </button>
                
                <a href="{{ request.path }}" class="btn btn-outline-secondary" title="Limpar Filtros">
                    <i class="fa-solid fa-eraser" title="Limpar filtros"></i>
                </a>
            </div>
            
        </form>
    </div>
</div>

<div class="row row-cards">
    <!-- Quantidade -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title">Qtde/Status do processo</h3>
                <div id="contagem-chart-status-processo"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title">Qtde/Status do orçamento</h3>
                <div id="contagem-chart-status-orcamento"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title">Qtde/Aprovação do orçamento</h3>
                <div id="contagem-chart-status-aprovacao"></div>
            </div>
        </div>
    </div>

    <!-- Valores monetários -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title">R$/Status do processo</h3>
                <div id="valor-chart-status-processo"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title">R$/Status do orçamento</h3>
                <div id="valor-chart-status-orcamento"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title">R$/Aprovação do orçamento</h3>
                <div id="valor-chart-status-aprovacao"></div>
            </div>
        </div>
    </div>






</div>
{% endblock %}


{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
    // Função para criar os gráficos
    function renderChart(elementId, chartData, unidade_medida, title_bar) {
        // Se não houver dados, exibe uma mensagem no console para debug
        if (!chartData || chartData.length === 0) {
            document.querySelector(elementId).innerHTML = "<p class='text-muted'>Sem dados para exibir</p>";
            return;
        }

        const options = {
            series: [{
                name: title_bar,
                data: chartData.map(item => parseFloat(item.total_valor))
            }],
            chart: { type: 'bar', height: 300, toolbar: { show: false } },
            colors: ['#206bc4'],
            xaxis: {
                // Aqui pegamos o nome do status dinamicamente
                categories: chartData.map(item => {
                    const keys = Object.keys(item);
                    return item[keys[0]] || "Não definido";
                })
            },
            yaxis: {
                labels: {
                    formatter: (value) => unidade_medida + " " + value.toLocaleString('pt-BR')
                }
            },
            tooltip: {
                y: { formatter: (value) => unidade_medida + " " + value.toLocaleString('pt-BR') }
            }
        };

        const chart = new ApexCharts(document.querySelector(elementId), options);
        chart.render();
    }

    // 2. Chamar a função para cada gráfico assim que o DOM carregar
    document.addEventListener("DOMContentLoaded", function () {
        renderChart("#valor-chart-status-processo", {{ valor_status_do_processo| safe }}, "R$", "Valot total");
        renderChart("#valor-chart-status-orcamento", {{ valor_status_do_orcamento| safe }}, "R$", "Valot total");
        renderChart("#valor-chart-status-aprovacao", {{ valor_status_do_orcamento_aprovacao| safe }}, "R$", "Valot total");

        renderChart("#contagem-chart-status-processo", {{ contagem_status_do_processo| safe }}, "", "Valot total");
        renderChart("#contagem-chart-status-orcamento", {{ contagem_status_do_orcamento| safe }}, "", "Valot total");
        renderChart("#contagem-chart-status-aprovacao", {{ contagem_status_do_orcamento_aprovacao| safe }}, "", "Valot total");
    });
</script>
{% endblock %}