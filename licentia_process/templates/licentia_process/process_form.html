{% extends "core/base.html" %}

{% block page_title %}{% if object %}Editar{% else %}Novo{% endif %} {{ verbose_name }}{% endblock %}

{% block extra_css %}
{{ form.media }}
<style>
    .ck-editor__editable { min-height: 200px; }
    /* Ajuste para o Tom Select não ficar esmagado */
    .ts-control { border: 1px solid #dadcde; border-radius: 4px; }

    .table td {
    max-width: 320px;
    word-break: break-word;
}


/* Botão Salvar e Permanecer - Fixo no Rodapé */
.btn-save-sticky {
    position: fixed;
    bottom: 90px; /* Distância do fundo */
    right: 30px;  /* Distância da direita */
    z-index: 1030;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
    border-radius: 50px;
    padding: 12px 25px;
    font-weight: 600;
    transition: all 0.2s ease-in-out;
    border: 2px solid #fff; /* Pequena borda para destacar de fundos variados */
}

.btn-save-sticky:hover {
    transform: translateY(-5px); /* Efeito de levante ao passar o mouse */
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

/* Ajuste para telas pequenas */
@media (max-width: 768px) {
    .btn-save-sticky {
        right: 20px;
        bottom: 90px;
        padding: 10px 20px;
        font-size: 0.9rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <form method="post" class="card shadow-sm" novalidate>
            {% csrf_token %}

            <button type="submit" name="_continue" class="btn btn-primary btn-save-sticky">
                <i class="fa-solid fa-sync-alt me-2"></i> Salvar e permanecer
            </button>


            <div class="card-status-top bg-teal"></div>

            <div class="card-body border-bottom py-3 bg-light">
                <div class="row">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Retranca</label>
                        {{ form.retranca }}
                        {% if form.retranca.errors %}<div class="text-danger small">{{ form.retranca.errors.0 }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Status do Processo</label>
                        {{ form.status_do_processo }}
                        {% if form.status_do_processo.errors %}<div class="text-danger small">{{ form.status_do_processo.errors.0 }}</div>{% endif %}
                    </div>
                </div>
            </div>
            
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" data-bs-toggle="tabs">
                    <li class="nav-item">
                        <a href="#tabs-identificacao" class="nav-link active" data-bs-toggle="tab">
                            <i class="fa-solid fa-id-card me-2"></i> Identificação
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tabs-fluxo-editorial" class="nav-link" data-bs-toggle="tab">
                            <i class="fa-solid fa-arrows-spin me-2"></i> Fluxo Editorial
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tabs-fluxo-autrec" class="nav-link" data-bs-toggle="tab">
                            <i class="fa-solid fa-arrows-spin me-2"></i> Fluxo AutRec
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tabs-financeiro" class="nav-link" data-bs-toggle="tab">
                            <i class="fa-solid fa-money-bill-wave me-2"></i> Financeiro
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tabs-termo-creditos" class="nav-link" data-bs-toggle="tab">
                            <i class="fa-solid fa-file-lines me-2"></i> Termos e créditos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tabs-historico" class="nav-link" data-bs-toggle="tab">
                            <i class="fa-solid fa-history me-2"></i> Histórico
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#tabs-diario" class="nav-link" data-bs-toggle="tab">
                            <i class="fa-solid fa-comments me-2"></i> Diário de bordo
                        </a>
                    </li>
                </ul>
            </div>

            <div class="card-body">
                <div class="tab-content">
                    
                    <div class="tab-pane active show" id="tabs-identificacao">
                        <div class="row">
                            {% include "licentia_process/includes/form_field.html" with field=form.projeto %}
                            {% include "licentia_process/includes/form_field.html" with field=form.componente %}
                            {% include "licentia_process/includes/form_field.html" with field=form.volume %}
                            {% include "licentia_process/includes/form_field.html" with field=form.localizacao_do_recurso %}
                            {% include "licentia_process/includes/form_field.html" with field=form.unidade %}
                            {% include "licentia_process/includes/form_field.html" with field=form.capitulo_secao %}
                            {% include "licentia_process/includes/form_field.html" with field=form.pagina %}
                            {% include "licentia_process/includes/form_field.html" with field=form.titulo_descricao %}
                            {% include "licentia_process/includes/form_field.html" with field=form.fornecedor %}
                            {% include "licentia_process/includes/form_field.html" with field=form.obra_original %}
                        </div>
                    </div>

                    <div class="tab-pane" id="tabs-fluxo-editorial">
                        <div class="row">
                            {% include "licentia_process/includes/form_field.html" with field=form.data_entrada %}
                            {% include "licentia_process/includes/form_field.html" with field=form.lote %}
                            {% include "licentia_process/includes/form_field.html" with field=form.status_analise_editorial %}
                            {% include "licentia_process/includes/form_field.html" with field=form.codigo_biblioteca_link %}
                            {% include "licentia_process/includes/form_field.html" with field=form.observacao_editorial %}
                        </div>
                    </div>

                    <div class="tab-pane" id="tabs-fluxo-autrec">
                        <div class="row">
                            
                            {% include "licentia_process/includes/form_field.html" with field=form.solicitar_imagem %}
                            {% include "licentia_process/includes/form_field.html" with field=form.enviar_formulario %}
                            
                            {% include "licentia_process/includes/form_field.html"  %}
                            {% include "licentia_process/includes/form_field.html" with field=form.status_analise_autrec %}
                            {% include "licentia_process/includes/form_field.html" with field=form.observacao_autrec %}
                        </div>
                    </div>

                    <div class="tab-pane" id="tabs-financeiro">
                        <div class="row">
                            {% include "licentia_process/includes/form_field.html" with field=form.valor_do_processo %}
                            {% include "licentia_process/includes/form_field.html" with field=form.status_do_orcamento %}
                            {% include "licentia_process/includes/form_field.html" with field=form.status_do_orcamento_aprovacao %}
                            {% include "licentia_process/includes/form_field.html"  %}

                            {% include "licentia_process/includes/form_field.html" with field=form.atribuido_a %}
                            {% include "licentia_process/includes/form_field.html" with field=form.status_do_freela_pagamento %}


                            {% include "licentia_process/includes/form_field.html" with field=form.empresa %}
                            {% include "licentia_process/includes/form_field.html" with field=form.centro_de_custo %}
                        </div>
                    </div>

                    <div class="tab-pane" id="tabs-termo-creditos">
                        <div class="row">
                            {% include "licentia_process/includes/form_field.html" with field=form.tipo_de_termo %}
                            {% include "licentia_process/includes/form_field.html" with field=form.credito_obrigatorio %}
                            {% include "licentia_process/includes/form_field.html" with field=form.observacao_exemplares %}
                            {% include "licentia_process/includes/form_field.html" with field=form.limitacao_anos %}
                            {% include "licentia_process/includes/form_field.html" with field=form.limitacao_edicao %}
                            {% include "licentia_process/includes/form_field.html" with field=form.limitacao_tiragem %}
                            {% include "licentia_process/includes/form_field.html" with field=form.limitacao_outros %}
                            
                            
                        </div>
                    </div>

                    <div class="tab-pane" id="tabs-historico">
                        <div class="table-responsive">
                            <table class="table table-vcenter card-table">
                                <thead>
                                    <tr>
                                        <th>Usuário</th>
                                        <th>Data</th>
                                        <th>Tipo</th>
                                        <th>Campo</th>
                                        <th>Valor antigo</th>
                                        <th>Novo valor</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in historico_alteracoes %}
                                        {% if record.history_type == '+' %}
                                            {# Linha exclusiva para o nascimento do processo #}
                                            <tr>
                                                <td>{{ record.history_user|default:"Sistema" }}</td>
                                                <td>{{ record.history_date|date:"d/m/Y H:i" }}</td>
                                                <td><span class="badge bg-success">Criação</span></td>
                                                <td colspan="3" class="text-muted">Registro inicial do processo</td>
                                            </tr>
                                        {% else %}
                                            {% for change in record.lista_changes %}
                                            <tr>
                                                <td>{{ record.history_user|default:"Sistema" }}</td>
                                        
                                                <td>{{ record.history_date|date:"d/m/Y H:i" }}</td>
                                        
                                                <td>
                                                    <span class="badge 
                                                            {% if record.history_type == '+' %}bg-success
                                                            {% elif record.history_type == '~' %}bg-warning
                                                            {% else %}bg-danger{% endif %}">
                                                        {{ record.get_history_type_display }}
                                                    </span>
                                                </td>
                                        
                                                <td>{{ change.verbose|capfirst }}</td>
                                        
                                                <td>
                                                    {% with old_value=change.old %}
                                                        {# Exibição na tabela: Traduz se for booleano, senão trunca o texto #}
                                                        {% if old_value is True or old_value is False %}
                                                            {{ old_value|yesno:"Sim,Não" }}
                                                        {% else %}
                                                            {{ old_value|default:"-"|striptags|truncatechars:80 }}
                                                        {% endif %}
                                                
                                                        {% if old_value|stringformat:"s"|length > 80 %}
                                                            <a href="#" data-bs-toggle="modal"
                                                                data-bs-target="#modal_old_{{ forloop.counter }}_{{ forloop.parentloop.counter }}">
                                                                ver mais
                                                            </a>
                                                
                                                            <div class="modal fade" id="modal_old_{{ forloop.counter }}_{{ forloop.parentloop.counter }}" tabindex="-1">
                                                                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                                                                    <div class="modal-content">
                                                                        <div class="modal-header">
                                                                            <h5 class="modal-title">Valor antigo - {{ change.verbose|capfirst }}</h5>
                                                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                                        </div>
                                                                        <div class="modal-body">
                                                                            {{ old_value|safe }}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                    {% endwith %}
                                                </td>
                                                
                                                <td>
                                                    {% with new_value=change.new %}
                                                        {# Exibição na tabela: Traduz se for booleano, senão trunca o texto #}
                                                        {% if new_value is True or new_value is False %}
                                                            {{ new_value|yesno:"Sim,Não" }}
                                                        {% else %}
                                                            {{ new_value|default:"-"|striptags|truncatechars:80 }}
                                                        {% endif %}
                                                
                                                        {% if new_value|stringformat:"s"|length > 80 %}
                                                            <a href="#" data-bs-toggle="modal"
                                                                data-bs-target="#modal_new_{{ forloop.counter }}_{{ forloop.parentloop.counter }}">
                                                                ver mais
                                                            </a>
                                                
                                                            <div class="modal fade" id="modal_new_{{ forloop.counter }}_{{ forloop.parentloop.counter }}" tabindex="-1">
                                                                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                                                                    <div class="modal-content">
                                                                        <div class="modal-header">
                                                                            <h5 class="modal-title">Novo valor - {{ change.verbose|capfirst }}</h5>
                                                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                                        </div>
                                                                        <div class="modal-body">
                                                                            {{ new_value|safe }}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        {% endif %}
                                                    {% endwith %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        
                                        {% endif %}
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                Nenhuma alteração registrada.
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane" id="tabs-diario">
                        <div class="mb-4">
                            <textarea id="log-texto" class="form-control" rows="3" placeholder="Digite um avanço..."></textarea>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-muted">Dica: Use <strong>Ctrl + Enter</strong> para postar rápido.</small>
                                <button type="button" id="btn-salvar-log" class="btn btn-primary">
                                    Postar no diário
                                </button>
                            </div>
                        </div>
                    
                        <div class="pt-3">
                            <ul class="timeline" id="timeline-logs">
                                {% for log in object.logs.all %}
                                <li class="timeline-event">
                                    <div class="timeline-event-icon bg-twitter-lt">
                                        <i class="fa-solid fa-comment"></i>
                                    </div>
                                    <div class="card timeline-event-card">
                                        <div class="card-body">
                                            <div class="text-muted float-end">{{ log.data_criacao|date:"d/m/Y H:i" }}</div>
                                            <h4>{{ log.usuario.get_full_name|default:log.usuario.username }}</h4>
                                            <p class="text-muted">{{ log.texto|linebreaksbr }}</p>
                                        </div>
                                    </div>
                                </li>
                                {% empty %}
                                <p id="no-logs" class="text-muted text-center">Nenhum registro ainda.</p>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                </div>
            </div>

            <div class="card-footer d-flex justify-content-between">
                <a href="{{ url_listagem }}" class="btn btn-link link-secondary">Cancelar</a>
                
                <div class="d-flex gap-2">
                    

                    <button type="submit" class="btn btn-teal">
                        <i class="fa-solid fa-check me-2"></i> Salvar e fechar
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}



{% block extra_js %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Procura o primeiro campo com erro
        var firstError = document.querySelector('.text-danger');
        if (firstError) {
            // Encontra a aba (tab-pane) pai desse erro
            var pane = firstError.closest('.tab-pane');
            if (pane) {
                // Ativa o link da aba correspondente
                var id = pane.getAttribute('id');
                var tabLink = document.querySelector('a[href="#' + id + '"]');
                var bsTab = new bootstrap.Tab(tabLink);
                bsTab.show();
            }
        }
    });
    document.addEventListener("DOMContentLoaded", function () {
        const logInput = document.getElementById('log-texto');
        const btnSalvar = document.getElementById('btn-salvar-log');

        // Função que executa o envio do AJAX
        function executarSalvamentoLog() {
            const texto = logInput.value.trim();
            const processoId = "{{ object.id }}";

            if (!texto) {
                alert("Digite algo antes de postar.");
                return;
            }

            fetch("{% url 'process:save_process_log' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: `texto=${encodeURIComponent(texto)}&processo_id=${processoId}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        logInput.value = ''; // Limpa o campo

                        const noLogs = document.getElementById('no-logs');
                        if (noLogs) noLogs.remove();

                        const timeline = document.getElementById('timeline-logs');
                        const novoItem = `
                    <li class="timeline-event">
                        <div class="timeline-event-icon bg-twitter-lt">
                            <i class="fa-solid fa-comment text-white"></i>
                        </div>
                        <div class="card timeline-event-card">
                            <div class="card-body">
                                <div class="text-muted float-end">${data.data}</div>
                                <h4>${data.usuario}</h4>
                                <p class="text-muted">${data.texto.replace(/\n/g, '<br>')}</p>
                            </div>
                        </div>
                    </li>`;
                        timeline.insertAdjacentHTML('afterbegin', novoItem);
                    }
                })
                .catch(error => console.error('Erro ao salvar log:', error));
        }

        // 1. Ouvinte para o Clique no Botão
        if (btnSalvar) {
            btnSalvar.addEventListener('click', executarSalvamentoLog);
        }

        // 2. Ouvinte para o Atalho Ctrl + Enter (no campo de texto)
        if (logInput) {
            logInput.addEventListener('keydown', function (event) {
                // Verifica Ctrl + Enter ou Meta(Mac) + Enter
                if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                    event.preventDefault(); // Evita o salto de linha
                    executarSalvamentoLog();
                }
            });
        }
    });
</script>
{% endblock %}